name: Devolv Action
description: Run Devolv DevOps Toolkit tools (drift v2, validate) in GitHub Actions

inputs:
  tool:
    description: Which Devolv tool to run (drift, validate)
    required: true
  policy-name:
    description: IAM policy name (required for drift)
    required: false
  path:
    description: Path to the local policy file or directory
    required: true
  github-token:
    description: GitHub token to use for API calls
    required: true
  fail-on-high-risk:
    description: Whether to fail the job if high-risk findings are detected (for validate)
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Install Devolv
      run: |
        pip install devolv==0.2.15 --disable-pip-version-check
      shell: bash

    - name: Run Devolv tool
      run: |
        export GITHUB_TOKEN="${{ inputs.github-token }}"
        echo "✅ GITHUB_TOKEN set"

        if [ -z "${{ inputs.path }}" ]; then
          echo "::error::❌ Path is required"
          exit 1
        fi

        if [ "${{ inputs.tool }}" = "drift" ]; then
          if [ ! -f "${{ inputs.path }}" ]; then
            echo "::error::❌ Drift requires a file path"
            exit 1
          fi

          # Run drift - we let Devolv handle the aws<->local logic
          if devolv drift --policy-name "${{ inputs.policy-name }}" --file "${{ inputs.path }}"; then
            echo "✅ No drift detected"
          else
            echo "::error::❌ Drift detected"
            exit 1
          fi

        elif [ "${{ inputs.tool }}" = "validate" ]; then
          if devolv validate "${{ inputs.path }}" --json | tee validate.json | grep -q '"level": "high"'; then
            cat validate.json
            echo "::error::❌ High-risk findings detected"
            exit 1
          else
            cat validate.json
            echo "✅ No high-risk findings"
          fi

        else
          echo "::error::❌ Unknown tool: ${{ inputs.tool }}"
          exit 1
        fi
      shell: bash

branding:
  icon: 'shield'
  color: 'blue'
